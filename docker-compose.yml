version: '3.8'

services:
  # The vulnerable application
  juice-shop:
    image: bkimminich/juice-shop
    container_name: juice-shop
    restart: always
    environment:
      - NODE_ENV=safe # We want some logging
    networks:
      - waf-net

  # The AI WAF Service
  waf-service:
    build:
      context: ./waf
      dockerfile: Dockerfile
    container_name: waf-service
    restart: always
    environment:
      - MODEL_PATH=/app/model/weights
    volumes:
      - ./waf:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - waf-net

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: waf-nginx
    restart: always
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - juice-shop
      - waf-service
    networks:
      - waf-net

networks:
  waf-net:
    driver: bridge
