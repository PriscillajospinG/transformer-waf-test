worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Detailed Log Format for Training
    log_format  waf_log  '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "$request_body"';

    access_log  /var/log/nginx/access.log waf_log;
    error_log   /var/log/nginx/error.log warn;

    sendfile        on;
    keepalive_timeout  65;

    # Upstream Definitions
    upstream juice_shop {
        server juice-shop:3000;
    }

    upstream waf_service {
        server waf-service:8000;
    }

    server {
        listen       80;
        server_name  localhost;

        # Protect the application
        location / {
            # 1. Check request with WAF
            auth_request /_waf_check;
            
            # If WAF returns 2xx, proceed to Juice Shop
            proxy_pass http://juice_shop;
            
            # Forward headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Internal location for WAF check
        location = /_waf_check {
            internal;
            
            # Forward the original request details to the WAF
            proxy_pass http://waf_service/analyze;
            
            proxy_pass_request_body on;
            proxy_set_header Content-Length $content_length;
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header X-Original-IP $remote_addr;
        }

        # Custom Error Page for Blocked Requests
        error_page 403 /blocked.html;
        location = /blocked.html {
            internal;
            return 403 "Request Blocked by Transformer WAF";
        }
    }
}
